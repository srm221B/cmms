# CMMS Deployment Guide for DigitalOcean VM

## Prerequisites

1. **DigitalOcean VM** with Ubuntu 20.04 or later
2. **SSH Key** configured for access to your VM
3. **VM IP Address** for deployment

## Quick Deployment

### Step 1: Prepare Your Local Environment

Make sure your SSH key is in the correct location:
```bash
# Your SSH key should be at:
~/.ssh/cmms-key.pem
```

### Step 2: Run the Production Deployment

```bash
# Replace YOUR_VM_IP with your actual VM IP address
./deploy_production.sh YOUR_VM_IP
```

This script will:
- ✅ Build the React frontend
- ✅ Upload files to your VM
- ✅ Install system dependencies
- ✅ Set up Python virtual environment
- ✅ Initialize SQLite database
- ✅ Create systemd service for production
- ✅ Configure nginx reverse proxy
- ✅ Set up firewall rules
- ✅ Start the application

### Step 3: Access Your Application

After deployment, your CMMS application will be available at:
```
http://YOUR_VM_IP
```

## Database Management

### On the VM (after deployment)

SSH into your VM and navigate to the application directory:
```bash
ssh -i ~/.ssh/cmms-key.pem ubuntu@YOUR_VM_IP
cd /home/ubuntu/cmms
```

### Database Setup Commands

```bash
# Full database setup (recommended for first time)
./database_setup.sh full

# Individual commands:
./database_setup.sh init    # Initialize database tables
./database_setup.sh data    # Create initial admin user
./database_setup.sh backup  # Create database backup
./database_setup.sh info    # Show database information
```

### Initial Login Credentials

After running the database setup, you can log in with:
- **Email**: `admin@cmms.com`
- **Password**: `admin123`

⚠️ **Important**: Change the admin password after first login!

## Application Management

### Service Commands

```bash
# Check service status
sudo systemctl status cmms

# View application logs
sudo journalctl -u cmms -f

# Restart application
sudo systemctl restart cmms

# Stop application
sudo systemctl stop cmms

# Start application
sudo systemctl start cmms
```

### Nginx Commands

```bash
# Check nginx status
sudo systemctl status nginx

# View nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# Restart nginx
sudo systemctl restart nginx

# Test nginx configuration
sudo nginx -t
```

## File Locations

```
/home/ubuntu/cmms/
├── venv/                    # Python virtual environment
├── backend/                 # FastAPI backend
│   ├── app/                # Application code
│   ├── static/             # Built React frontend
│   ├── cmms.db            # SQLite database
│   └── .env               # Environment variables
├── frontend/               # React frontend source
└── database_setup.sh      # Database management script
```

## Environment Configuration

The deployment script creates a `.env` file with:
```env
DATABASE_URL=sqlite:///./cmms.db
SECRET_KEY=<auto-generated-secure-key>
CORS_ORIGINS=http://YOUR_VM_IP,http://YOUR_VM_IP:3000,http://localhost:3000
DEBUG=false
```

## Troubleshooting

### Application Not Starting

1. Check service status:
   ```bash
   sudo systemctl status cmms
   ```

2. View logs:
   ```bash
   sudo journalctl -u cmms -f
   ```

3. Check if port 8000 is in use:
   ```bash
   sudo netstat -tlnp | grep :8000
   ```

### Database Issues

1. Check database file:
   ```bash
   ls -la /home/ubuntu/cmms/backend/cmms.db
   ```

2. Reinitialize database:
   ```bash
   cd /home/ubuntu/cmms
   ./database_setup.sh full
   ```

### Nginx Issues

1. Check nginx configuration:
   ```bash
   sudo nginx -t
   ```

2. View nginx error logs:
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

### Firewall Issues

1. Check firewall status:
   ```bash
   sudo ufw status
   ```

2. Allow required ports:
   ```bash
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   ```

## Security Considerations

1. **Change Default Passwords**: Update the admin password after first login
2. **SSL Certificate**: Consider adding SSL/TLS certificate for HTTPS
3. **Firewall**: Ensure only necessary ports are open
4. **Regular Updates**: Keep the system updated
5. **Database Backups**: Regularly backup the SQLite database

## Backup and Restore

### Backup Database
```bash
cd /home/ubuntu/cmms
./database_setup.sh backup
```

### Restore Database
```bash
cd /home/ubuntu/cmms
./database_setup.sh restore
```

## Monitoring

### Check Application Health
```bash
curl http://YOUR_VM_IP/api/health
```

### Monitor System Resources
```bash
# CPU and memory usage
htop

# Disk usage
df -h

# Application logs
sudo journalctl -u cmms -f
```

## Updates and Maintenance

### Update Application
1. Make changes to your local code
2. Run the deployment script again:
   ```bash
   ./deploy_production.sh YOUR_VM_IP
   ```

### System Updates
```bash
sudo apt update && sudo apt upgrade -y
```

## Support

If you encounter issues:
1. Check the logs using the commands above
2. Verify all prerequisites are met
3. Ensure your VM has sufficient resources (at least 1GB RAM, 1 CPU)
4. Check that your SSH key has proper permissions (`chmod 600 ~/.ssh/cmms-key.pem`) 